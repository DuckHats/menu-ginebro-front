<main
  class="min-h-screen bg-slate-50/50 flex items-center justify-center p-6"
  @fadeIn
>
  <section
    class="w-full max-w-4xl bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden"
  >
    <div class="p-8 lg:p-10">
      <!-- Header -->
      <header
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6 mb-10"
      >
        <div class="flex items-center gap-4">
          <div
            class="w-14 h-14 bg-primary rounded-2xl flex items-center justify-center shadow-lg shadow-primary/20"
          >
            <mat-icon class="text-white text-2xl">restaurant_menu</mat-icon>
          </div>
          <div class="flex flex-col">
            <h1 class="text-2xl font-bold text-slate-800 tracking-tight">
              {{ UILabels.MENU_SELECTION.TITLE }}
            </h1>
            <p class="text-slate-500 font-medium text-sm">
              {{ UILabels.MENU_SELECTION.SUBTITLE }}
            </p>
          </div>
        </div>

        <!-- Dynamic Menu Image Button -->
        <button
          *ngIf="activeMenuImage"
          (click)="downloadActiveImage()"
          class="px-6 py-3 bg-white border border-slate-100 rounded-2xl shadow-sm hover:shadow-md transition-all flex items-center gap-3 group animate-fadeIn"
        >
          <div
            class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center text-primary group-hover:scale-110 transition-transform"
          >
            <mat-icon class="text-lg">download</mat-icon>
          </div>
          <span
            class="text-xs font-black text-slate-700 uppercase tracking-widest"
            >{{ UILabels.MENU_SELECTION.DOWNLOAD_BUTTON }}</span
          >
        </button>
      </header>

      <div class="space-y-8 sm:space-y-12">
        <!-- Top Section: Calendar & Options Side-by-Side -->
        <div
          class="grid grid-cols-1 lg:grid-cols-12 gap-6 sm:gap-10 items-stretch"
        >
          <!-- Left: Calendar -->
          <div class="lg:col-span-7">
            <div
              class="bg-slate-50/50 rounded-[1.5rem] sm:rounded-[2.5rem] p-3 sm:p-6 border border-slate-100 shadow-inner h-full flex flex-col justify-center"
            >
              <h3
                class="text-[10px] sm:text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-4 sm:mb-6 text-center"
              >
                {{ UILabels.MENU_SELECTION.SELECT_DAY }}
              </h3>
              <app-weekly-calendar
                [disabledDates]="disabledDates"
                (daySelected)="onDateSelected($event)"
                (weekChanged)="onWeekChanged($event)"
              >
              </app-weekly-calendar>
            </div>
          </div>

          <!-- Right: Taper & Menu Type -->
          <div class="lg:col-span-5 flex flex-col gap-4 sm:gap-6">
            <!-- TÃ per Option -->
            <div
              (click)="toggleTaper()"
              class="group cursor-pointer p-4 sm:p-6 rounded-[1.5rem] sm:rounded-[2rem] border-2 transition-all flex items-center justify-between min-h-[5rem] sm:h-1/2 bg-white"
              [ngClass]="
                taperSelected
                  ? 'border-primary ring-4 ring-primary/5'
                  : 'border-slate-100 hover:border-slate-200 shadow-sm'
              "
            >
              <div class="flex items-center gap-3 sm:gap-5">
                <div
                  class="w-10 h-10 sm:w-14 sm:h-14 rounded-xl sm:rounded-2xl flex items-center justify-center transition-all shadow-md sm:shadow-lg"
                  [ngClass]="
                    taperSelected
                      ? 'bg-primary text-white shadow-primary/20'
                      : 'bg-slate-50 text-slate-400'
                  "
                >
                  <mat-icon class="text-xl sm:text-2xl"
                    >takeout_dining</mat-icon
                  >
                </div>
                <div>
                  <p class="font-black text-slate-800 text-xs sm:text-sm">
                    {{ UILabels.MENU_SELECTION.TAPER_LABEL }}
                  </p>
                  <p
                    class="text-[8px] sm:text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mt-1"
                  >
                    {{ UILabels.MENU_SELECTION.TAPER_SUBTITLE }}
                  </p>
                </div>
              </div>
              <div
                class="w-6 h-6 sm:w-8 sm:h-8 rounded-full border-2 flex items-center justify-center transition-all"
                [ngClass]="
                  taperSelected
                    ? 'border-primary bg-primary'
                    : 'border-slate-100 bg-slate-50'
                "
              ></div>
            </div>

            <!-- Menu Type Selection -->
            <div
              class="bg-slate-50/50 rounded-[1.5rem] sm:rounded-[2rem] p-4 sm:p-6 border border-slate-100 space-y-3 sm:space-y-4 min-h-[5rem] sm:h-1/2 flex flex-col justify-center"
            >
              <h3
                class="text-[9px] sm:text-[10px] font-black text-slate-400 uppercase tracking-widest"
              >
                {{ UILabels.MENU_SELECTION.MENU_TYPE_TITLE }}
              </h3>
              <div class="grid grid-cols-3 gap-2 sm:gap-3">
                <button
                  *ngFor="let type of menuTypes; let i = index"
                  (click)="selectMenuType(i)"
                  class="group relative p-2 sm:p-4 rounded-xl sm:rounded-2xl border-2 transition-all flex flex-col items-center justify-center gap-1 sm:gap-2 text-center overflow-hidden"
                  [ngClass]="
                    type.selected
                      ? 'bg-primary border-primary text-white shadow-lg'
                      : 'bg-white border-slate-50 text-slate-400 hover:border-slate-200'
                  "
                >
                  <mat-icon
                    class="text-lg sm:text-xl w-5 h-5 sm:w-6 sm:h-6"
                    [ngClass]="type.selected ? 'text-white' : 'text-slate-300'"
                    >restaurant</mat-icon
                  >
                  <span
                    class="font-black text-[7px] sm:text-[9px] uppercase tracking-wider leading-tight"
                    >{{ type.name }}</span
                  >
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Bottom Section: Dishes (Responsive Grid) -->
        <div class="relative space-y-8 sm:space-y-10">
          <!-- Restriction Alert -->
          <div
            *ngIf="isRestricted"
            class="p-5 sm:p-6 bg-rose-100/30 border-2 border-rose-200/50 rounded-[2rem] flex items-center gap-4 sm:gap-6 animate-fadeIn relative z-[11] shadow-xl shadow-rose-900/5"
          >
            <div
              class="w-12 h-12 bg-rose-500 rounded-2xl flex items-center justify-center shadow-lg shadow-rose-500/40 shrink-0"
            >
              <mat-icon class="text-white text-2xl">block</mat-icon>
            </div>
            <div class="space-y-1">
              <p
                class="font-black text-rose-900 uppercase tracking-widest text-[10px] sm:text-xs"
              >
                {{ UILabels.MENU_SELECTION.RESTRICTED_DATE_TITLE }}
              </p>
              <p
                class="text-sm sm:text-lg font-black text-rose-700 leading-tight"
              >
                {{ restrictionReason }}
              </p>
            </div>
          </div>

          <!-- Overlay when restricted -->
          <div
            *ngIf="isRestricted"
            class="absolute -inset-2 sm:-inset-6 bg-white/40 backdrop-blur-[4px] z-[5] rounded-[2rem] sm:rounded-[3rem] cursor-not-allowed"
          ></div>

          <!-- Dishes Flow -->
          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-8"
            *ngIf="hasSelectedMenuType()"
          >
            <div
              *ngFor="let section of filteredMenuSections(); let sIdx = index"
              class="space-y-4 sm:space-y-6 animate-fadeIn"
            >
              <h3
                class="text-[10px] sm:text-[11px] font-black text-slate-800 uppercase tracking-[0.2em] flex items-center gap-2 sm:gap-3"
              >
                <span
                  class="w-1 h-4 sm:w-1.5 sm:h-5 bg-primary rounded-full"
                ></span>
                {{ section.title }}
              </h3>
              <div class="space-y-2 sm:space-y-3">
                <app-menu-option-card
                  *ngFor="let option of section.options; let oIdx = index"
                  [option]="option"
                  [sectionTitle]="section.title"
                  (select)="selectOption(getActualIndex(section.title), oIdx)"
                >
                </app-menu-option-card>
              </div>
            </div>
          </div>

          <!-- Empty Selection State -->
          <div
            *ngIf="!hasSelectedMenuType()"
            class="py-12 sm:py-16 text-center bg-slate-50/50 rounded-[1.5rem] sm:rounded-[2.5rem] border-2 border-dashed border-slate-200/50"
          >
            <div
              class="w-12 h-12 sm:w-16 sm:h-16 bg-white rounded-xl sm:rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-md border border-slate-100"
            >
              <mat-icon class="text-slate-200 text-2xl sm:text-3xl"
                >touch_app</mat-icon
              >
            </div>
            <p
              class="text-slate-400 font-black uppercase tracking-widest text-[9px] sm:text-[10px] max-w-[200px] sm:max-w-[250px] mx-auto leading-relaxed"
            >
              {{ UILabels.MENU_SELECTION.EMPTY_STATE }}
            </p>
          </div>

          <!-- Confirm Button -->
          <div class="pt-4 sm:pt-6 relative z-[10]">
            <button
              (click)="confirmSelection()"
              [disabled]="!hasSelectedMenuType() || isRestricted"
              class="w-full bg-primary hover:bg-primary-dark disabled:bg-slate-200 disabled:text-slate-400 text-white py-4 sm:py-6 rounded-xl sm:rounded-[2rem] font-black shadow-xl sm:shadow-2xl shadow-primary/30 transition-all active:scale-[0.96] flex items-center justify-center gap-2 sm:gap-3 group relative overflow-hidden"
            >
              <mat-icon
                class="text-xl sm:text-2xl group-hover:rotate-12 transition-transform"
                >verified</mat-icon
              >
              <span
                class="text-sm sm:text-base uppercase tracking-[0.2em] font-black"
                >{{ UILabels.MENU_SELECTION.CONFIRM_BUTTON }}</span
              >
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<app-intro-modal *ngIf="showIntroModal" (close)="closeIntroModal()">
</app-intro-modal>

<app-confirm-modal
  *ngIf="showConfirmModal"
  [selectedDate]="selectedDate"
  [menuTypeName]="getSelectedMenuTypeName()"
  [selectedOptions]="getSelectedOptionsSummary()"
  [taperSelected]="taperSelected"
  [price]="orderPrice"
  [basePrice]="orderBasePrice"
  [taperSurcharge]="orderTaperSurcharge"
  [hasEnoughBalance]="hasEnoughBalance"
  [userBalance]="userBalance"
  (confirm)="submitOrder()"
  (cancel)="cancelConfirmation()"
  (recharge)="onRecharge()"
>
</app-confirm-modal>
